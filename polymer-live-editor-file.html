<!--
@license
Copyright (c) 2017 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-behaviors/iron-button-state.html">
<link rel="import" href="../iron-behaviors/iron-control-state.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-behaviors/paper-ripple-behavior.html">

<!-- 
`polymer-live-editor-file` handles file selection for `polymer-live-editor`.

Example (notice one block inserts code inside a template and one directly edits the `fileContent` property):
  <polymer-live-editor src="http://localhost:3000">
    <polymer-live-editor-file file-name="custom-element.html" id="customel">
      <div slot="heading">
        custom-element.html
      </div>
      <template slot="file-content"></template>
    </polymer-live-editor-file>
    <polymer-live-editor-file file-name="index.html">
      <div slot="heading">
        index.html
      </div>
      <template slot="file-content">
        <script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
        <link rel="import" href="custom-element.html">
        <custom-element></custom-element>
      </template>
    </polymer-live-editor-file>
  </polymer-live-editor>

  <script>
    var fileContent = `<link rel="import"  href="/bower_components/polymer/polymer-element.html">
      <script>
        // Define the class for a new element called custom-element
        class CustomElement extends Polymer.Element {
          static get is() { return "custom-element"; }
          constructor() {
              super();
              this.textContent = "I'm a custom-element.";
            }
        }
        // Register the new element with the browser
        customElements.define(CustomElement.is, CustomElement);
      <\/script>`;
    document.querySelector('#customel').fileContent = fileContent;
  </script>


The `polymer-live-editor` is used with as many `polymer-live-editor-file`s as are needed for the demo. A `polymer-live-editor-file` has one required property: `fileName`. Note that as long as the `polymer-live-editor-file` is given a name, anything can be displaying in the file itself. File content should be placed in a container with its `slot` attribute set to `heading`.

Each `polymer-live-editor-file` has a property called `fileContent`, which can be either set explicitly in Javascript (see the custom-element.html file in the example) or will be computed based on the innerHTML of a template with slot `file-content` (the index.html file in the example). 
 -->

<dom-module id="polymer-live-editor-file">
  <template>
    <style>
      :host {
        @apply --layout-inline;
        @apply --layout-center;
        @apply --layout-center-justified;
        @apply --layout-flex-auto;

        position: relative;
        padding: 0 12px;
        overflow: hidden;
        cursor: pointer;
        vertical-align: middle;
      }

      :host(:focus) {
        outline: none;
      }

      :host([link]) {
        padding: 0;
      }

      .file-content {
        height: 100%;
        transform: translateZ(0);
        transition: opacity 0.1s cubic-bezier(0.4, 0.0, 1, 1);
        @apply --layout-horizontal;
        @apply --layout-center-center;
        @apply --layout-flex-auto;
      }

      :host(:not(.iron-selected)) > .file-content {
        opacity: 0.8;
      }

      :host(:focus) .file-content {
        opacity: 1;
        font-weight: 700;
      }

      .file-content > ::content > a {
        @apply --layout-flex-auto;

        height: 100%;
      }
    </style>

    <div class="file-content">
      <slot id="heading" name="heading"></slot>
    </div>
    <slot id="filecontent" name="file-content"></slot>
  </template>

  <script>
    Polymer({
      is: 'polymer-live-editor-file',

      behaviors: [
        Polymer.IronControlState,
        Polymer.IronButtonState,
        Polymer.PaperRippleBehavior
      ],

      properties: {

        /**
         * Content of the `file-content` slot. Can be set programmatically or in HTML. 
         */
        fileContent: {
          type: String,
          observer: '_fileContentChanged'
        },
        /**
         * Name of file, required for housekeeping.
         */
        fileName: {
          type: String
        }

      },

      hostAttributes: {
        role: 'tab'
      },

      listeners: {
        down: '_updateNoink',
        'user-edited-file': '_onUserEditedFile'
      },

      attached: function() {
        this._updateNoink();
        this._fileContentObserver = new MutationObserver(this._onSlotChange.bind(this));       

        this._templateObserver = Polymer.dom(this.$.filecontent).observeNodes(function(mutations) {
          
          var slot = Polymer.dom(this.$.filecontent); 
          var nodes  = slot.assignedNodes ? slot.assignedNodes({flatten: true}) : slot.getDistributedNodes();
          this._template = nodes.length ? nodes[0] : null;

          if (this._template && this._template.content) {
            this._fileContentObserver.disconnect();
            this._fileContentObserver.observe(this._template.content, {attributes: true, childList: true, subtree: true});
            this._onSlotChange();
          }

        }.bind(this));
      },

      detached: function() {
        this._fileContentObserver.disconnect();
        Polymer.dom(this.$.filecontent).unobserveNodes(this._templateObserver);
      },

      _onSlotChange: function() { 
        if (!this._template || !this._template.innerHTML) return;
        this._fromEditor = false;
        this.fileContent = this._template.innerHTML;
      },

      _onUserEditedFile: function(event) {
        this._fromEditor = true;
        this.fileContent = event.detail.fileContent;
      },

      _fileContentChanged: function() { 
        if (this._fromEditor && this._template) {
          this._template.innerHTML = this.fileContent;  
        } 

        this.fire('file-content-changed', {content: this.fileContent, fileName: this.fileName, updateMirror: !this._fromEditor});
        this._fromEditor = false;
      },

      _updateNoink: function() {
        var parent = Polymer.dom(this).parentNode;
        var parentNoInk = !!parent && !!parent.noink;
        this.noink = !!this.noink || !!parentNoInk;
      },

    });
  </script>
</dom-module>

