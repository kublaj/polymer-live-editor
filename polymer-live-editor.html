<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../codemirror-textarea/codemirror-textarea.html">
<link rel="import" href="polymer-live-editor-file.html">

<!-- 
`polymer-live-editor` is an inline code editor and previewer supporting multiple files. 

Example (notice one block inserts code inside a template and one directly edits the `fileContent` property):
    <polymer-live-editor src="http://localhost:3000">
      <polymer-live-editor-file file-name="custom-element.html" id="customel">
        <div slot="heading">
          custom-element.html
        </div>
        <template slot="file-content"></template>
      </polymer-live-editor-file>
      <polymer-live-editor-file file-name="index.html">
        <div slot="heading">
          index.html
        </div>
        <template slot="file-content">
          <script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
          <link rel="import" href="custom-element.html">
          <custom-element></custom-element>
        </template>
      </polymer-live-editor-file>
    </polymer-live-editor>

    <script>
      var fileContent = `<link rel="import"  href="/bower_components/polymer/polymer-element.html">
        <script>
          // Define the class for a new element called custom-element
          class CustomElement extends Polymer.Element {
            static get is() { return "custom-element"; }
            constructor() {
                super();
                this.textContent = "I'm a custom-element.";
              }
          }
          // Register the new element with the browser
          customElements.define(CustomElement.is, CustomElement);
        <\/script>`;
      document.querySelector('#customel').fileContent = fileContent;
    </script>

The `polymer-live-editor` is used with as many `polymer-live-editor-file`s as are needed for the demo. A `polymer-live-editor-file` has one required property: `fileName`. Note that as long as the `polymer-live-editor-file` is given a name, anything can be displayed in the file itself. File content should be placed in a container with its `slot` attribute set to `heading`.

Each `polymer-live-editor-file` has a property called `fileContent`, which can be either set explicitly in Javascript (see the custom-element.html file in the example) or will be computed based on the innerHTML of a template with slot `file-content` (the index.html file in the example). 
 -->

<dom-module id='polymer-live-editor'>
  <template>
    <style include="iron-flex">
      :host {
        display: block;
        box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14),
                    0 1px 5px 0 rgba(0, 0, 0, 0.12),
                    0 3px 1px -2px rgba(0, 0, 0, 0.2);
      }

      paper-tabs {
        color: black;
        --paper-tabs-selection-bar-color: black;
      }

      .tabstrip a {
        text-decoration: none;
      }

      iframe {
        width: 100%;
        overflow: hidden;
      }

      .results {
        box-sizing: border-box;
        background: white;
        width: 100%;
        padding: 20px;
        margin: 0;
        background-color: #fafafa;
        border-top: 1px solid #e0e0e0;
      }

    </style>

    <div class="tabstrip layout horizontal center">
      <paper-tabs id="demofiles" selected="{{selectedFileName}}" attr-for-selected="file-name" class="flex" selectable="polymer-live-editor-file">
        <slot></slot>
      </paper-tabs>
    </div>

     <codemirror-textarea value="{{value}}"></codemirror-textarea> 
     <div class="results">
       <iframe id="frame" src$="[[src]]" scrolling="no" frameborder="0" height$="[[height]]"></iframe>
     </div>

  </template>

  <script>
  Polymer({
    is: 'polymer-live-editor',

    properties: {
      /**
       * Name of initially selected file
       */
      selectedFileName: {
        type: String,
        observer: '_selectedFileNameChanged',
        value: 'index.html'
      },
      /**
       * Height of iframe displaying preview. Can be an integer
       * representing the number of pixels or a string containing a
       * CSS length value (e.g. '100px').
       */
      height: {
        type: String,
        value: '100px'
      },
      /**
       * URL for server where user code runs
       */
      src: {
        type: String
      }
    },

    listeners: {
      'file-content-changed': '_onFileContentChanged',
      'mirror-changed': '_onMirrorChanged'
    },

    ready: function() {
      window.addEventListener('message', this._onMessage.bind(this));
      this.$.frame.onload = this._onLoad.bind(this);
    },

    _onLoad: function() {
      this._initIframeContent();
    },

    get _fileContents() {
      var fileContents = {};
      var maybeFiles = Polymer.dom(this).children;

      // forEach doesn't work with class HTMLCollection
      var maybeFile; 
      for (var nodeIndex = 0; nodeIndex < maybeFiles.length; nodeIndex++) {
        maybeFile = maybeFiles[nodeIndex];
        if (maybeFile.hasOwnProperty('fileName')) {
          fileContents[maybeFile.fileName] = maybeFile.fileContent;
        }
      }

      return fileContents;
    },

    _updateFrame: function() {
      this._postMessage({codeObj: this._fileContents});
    },

    _onMirrorChanged: function(event) {
      this._fromEditor = true;
      this.displayedContent = event.detail.fileContent;
      var selectedFile = this._getSelectedFile();
      if (selectedFile) {
        selectedFile.fire('user-edited-file', {fileContent: this.displayedContent});
      }
    },

    _onFileContentChanged: function(event) {
      if (event.detail.content) {
        this.displayedContent = this._fileContents[this.selectedFileName];
        this._updateFrame();
        if (event.detail.updateMirror) this._updateMirror();
      }
    },

    _selectedFileNameChanged: function() {
      if (!this._fileContents) return;
      this.displayedContent = this._fileContents[this.selectedFileName];
      this._fromEditor = false;
      this._updateMirror();
    },

    _postMessage: function(content) {  
      if (!this._frameReady) return;
      
      this.debounce('postMessage', function () { 
        this.$.frame.contentWindow.postMessage(content, this.src); 
      }.bind(this), 400);
    },

    _onMessage: function(event) {
      if (event.data.ready) this._initIframeContent();
    },

    _updateMirror: function() {
      if (!this._fromEditor) {
        this.value = this.displayedContent;
      }
      this._fromEditor = false;
    },

    _initIframeContent: function() {
      this._frameReady = true;
      this._updateFrame();
    },

    _getSelectedFile: function() {
      var maybeFiles = Polymer.dom(this).children;

      var maybeFile; 
      for (var nodeIndex = 0; nodeIndex < maybeFiles.length; nodeIndex++) {
        maybeFile = maybeFiles[nodeIndex];
        if (maybeFile.hasOwnProperty('fileName') && 
            maybeFile.fileName === this.selectedFileName) {
          return maybeFile;
        }
      }
    }

  });
  </script>
</dom-module>

